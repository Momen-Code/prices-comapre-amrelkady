<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª - ØªØµÙ…ÙŠÙ… Ø¨Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBnH-VzVeKw4-ebADGCyS_QIVWcolQqwF4",
        authDomain: "amrelkady-7455d.firebaseapp.com",
        projectId: "amrelkady-7455d",
        storageBucket: "amrelkady-7455d.firebasestorage.app",
        messagingSenderId: "1068284076708",
        appId: "1:1068284076708:web:02d47cc40d81cb6e21bc31",
        measurementId: "G-4YGNNJN2JH",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const userDocRef = doc(db, "shared_comparisons", "global");

      (async () => {
        const docSnap = await getDoc(userDocRef);
        if (docSnap.exists()) {
          const data = docSnap.data().list || [];
          data.forEach((item) => createComparisonCard(item));
        } else {
          createComparisonCard();
        }
      })();

      function saveToFirestore(data) {
        setDoc(userDocRef, { list: data });
      }

      function calculateAndUpdate(card) {
        const inputs = card.querySelectorAll("input");
        const aCompany = inputs[0].value;
        const bCompany = inputs[4].value;
        const aPrice = parseFloat(inputs[2].value) || 0;
        const aWeight = parseFloat(inputs[3].value) || 0;
        const bPrice = parseFloat(inputs[6].value) || 0;
        const bWeight = parseFloat(inputs[7].value) || 0;
        const aKilo = aWeight ? (aPrice / aWeight).toFixed(2) : "-";
        const bKilo = bWeight ? (bPrice / bWeight).toFixed(2) : "-";

        card.querySelector(".a-kilo").textContent = aKilo;
        card.querySelector(".b-kilo").textContent = bKilo;

        const result1 = card.querySelector(".better-price");
        const result2 = card.querySelector(".price-diff");

        if (aKilo !== "-" && bKilo !== "-") {
          const a = parseFloat(aKilo);
          const b = parseFloat(bKilo);
          if (a === b) {
            result1.textContent = "ØªØ¹Ø§Ø¯Ù„";
            result2.textContent = "0%";
          } else {
            const better = a < b ? aCompany : bCompany;
            const diff = ((Math.abs(a - b) / Math.max(a, b)) * 100).toFixed(1);
            result1.textContent = better;
            result2.textContent = `${diff}%`;
          }
        } else {
          result1.textContent = "-";
          result2.textContent = "-";
        }
      }

      window.updateStorage = function () {
        const cards = document.querySelectorAll("#product-comparisons > div");
        const data = Array.from(cards).map((card) => {
          calculateAndUpdate(card);
          const inputs = card.querySelectorAll("input");
          return {
            aCompany: inputs[0].value,
            aProduct: inputs[1].value,
            aPrice: inputs[2].value,
            aWeight: inputs[3].value,
            bCompany: inputs[4].value,
            bProduct: inputs[5].value,
            bPrice: inputs[6].value,
            bWeight: inputs[7].value,
          };
        });
        saveToFirestore(data);
      };

      window.createComparisonCard = function (data = {}) {
        const container = document.getElementById("product-comparisons");
        const card = document.createElement("div");
        card.className =
          "bg-white shadow rounded-xl p-6 relative group text-right";
        card.innerHTML = `
        <button class="absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white w-8 h-8 rounded-full flex items-center justify-center shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200" title="Ø­Ø°Ù" onclick="this.parentElement.remove(); window.updateStorage();">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="border rounded-lg p-4">
            <input type="text" class="text-xl font-bold text-blue-700 mb-2 w-full text-right" value="${
              data.aCompany || "Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø£ÙˆÙ„Ù‰"
            }" />
            <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" class="mb-2 w-full border p-2 rounded text-right" value="${
              data.aProduct || ""
            }" />
            <input type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ" class="mb-2 w-full border p-2 rounded text-right" value="${
              data.aPrice || ""
            }" />
            <input type="number" placeholder="Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)" class="mb-2 w-full border p-2 rounded text-right" value="${
              data.aWeight || ""
            }" />
            <div class="text-gray-700 font-semibold text-right">Ø³Ø¹Ø± Ø§Ù„ÙƒÙŠÙ„Ùˆ: <span class="a-kilo text-black">-</span></div>
          </div>
          <div class="border rounded-lg p-4">
            <input type="text" class="text-xl font-bold text-green-700 mb-2 w-full text-right" value="${
              data.bCompany || "Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ©"
            }" />
            <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" class="mb-2 w-full border p-2 rounded text-right" value="${
              data.bProduct || ""
            }" />
            <input type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ" class="mb-2 w-full border p-2 rounded text-right" value="${
              data.bPrice || ""
            }" />
            <input type="number" placeholder="Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)" class="mb-2 w-full border p-2 rounded text-right" value="${
              data.bWeight || ""
            }" />
            <div class="text-gray-700 font-semibold text-right">Ø³Ø¹Ø± Ø§Ù„ÙƒÙŠÙ„Ùˆ: <span class="b-kilo text-black">-</span></div>
          </div>
        </div>
        <div class="mt-6 border-t pt-4 grid grid-cols-2 gap-4 text-center">
          <div class="text-lg font-bold text-indigo-600">Ø§Ù„Ø£ÙØ¶Ù„ Ø³Ø¹Ø±Ø§Ù‹: <span class="better-price text-black">-</span></div>
          <div class="text-lg font-bold text-indigo-600">ÙØ±Ù‚ Ø§Ù„Ø³Ø¹Ø± (%): <span class="price-diff text-black">-</span></div>
        </div>`;

        container.appendChild(card);
        window.updateStorage();
        card.querySelectorAll("input").forEach((input) => {
          input.addEventListener("input", window.updateStorage);
        });
      };

      window.addComparisonCard = function () {
        window.createComparisonCard();
      };

      window.exportToExcel = function () {
        const cards = document.querySelectorAll("#product-comparisons > div");
        const rows = [
          [
            "Ø§Ù„Ø´Ø±ÙƒØ©",
            "Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬",
            "Ø§Ù„Ø³Ø¹Ø±",
            "Ø§Ù„ÙˆØ²Ù†",
            "Ø³Ø¹Ø± Ø§Ù„ÙƒÙŠÙ„Ùˆ",
            "Ø§Ù„Ø£ÙØ¶Ù„ Ø³Ø¹Ø±Ø§Ù‹",
            "ÙØ±Ù‚ Ø§Ù„Ø³Ø¹Ø± (%)",
          ],
        ];

        cards.forEach((card) => {
          const inputs = card.querySelectorAll("input");
          const aCompany = inputs[0].value;
          const aProduct = inputs[1].value;
          const aPrice = inputs[2].value;
          const aWeight = inputs[3].value;
          const aKilo = card.querySelector(".a-kilo").textContent;

          const bCompany = inputs[4].value;
          const bProduct = inputs[5].value;
          const bPrice = inputs[6].value;
          const bWeight = inputs[7].value;
          const bKilo = card.querySelector(".b-kilo").textContent;

          const better = card.querySelector(".better-price").textContent;
          const diff = card.querySelector(".price-diff").textContent;

          rows.push([aCompany, aProduct, aPrice, aWeight, aKilo, better, diff]);
          rows.push([bCompany, bProduct, bPrice, bWeight, bKilo, "", ""]);
          rows.push([]);
        });

        const worksheet = XLSX.utils.aoa_to_sheet(rows);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø§Øª");
        XLSX.writeFile(workbook, "Ù…Ù‚Ø§Ø±Ù†Ø©_Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª.xlsx");
      };
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Cairo", sans-serif;
        background-color: #f9fafb;
      }
    </style>
  </head>
  <body class="p-6">
    <div class="container mx-auto max-w-6xl">
      <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">
        Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ù†ØªØ¬Ø§Øª Ø´Ø±ÙƒØªÙŠÙ†
      </h1>

      <div id="product-comparisons" class="space-y-6"></div>

      <div class="flex justify-end mt-6 gap-4">
        <button
          onclick="addComparisonCard()"
          class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow"
        >
          + Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø§Ø±Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø©
        </button>
        <button
          onclick="exportToExcel()"
          class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow"
        >
          ğŸ“¤ ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel
        </button>
      </div>
    </div>
  </body>
</html>
