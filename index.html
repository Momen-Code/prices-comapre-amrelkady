<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª - ØªØµÙ…ÙŠÙ… Ø¨Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        addDoc,
        setDoc,
        doc,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBnH-VzVeKw4-ebADGCyS_QIVWcolQqwF4",
        authDomain: "amrelkady-7455d.firebaseapp.com",
        projectId: "amrelkady-7455d",
        storageBucket: "amrelkady-7455d.firebasestorage.app",
        messagingSenderId: "1068284076708",
        appId: "1:1068284076708:web:02d47cc40d81cb6e21bc31",
        measurementId: "G-4YGNNJN2JH",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const comparisonsRef = collection(db, "comparisons");

      async function fetchData() {
        const snapshot = await getDocs(comparisonsRef);
        return snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
      }

      async function saveSheet(id, data) {
        await setDoc(doc(db, "comparisons", id), data);
      }

      window.addEventListener("DOMContentLoaded", async () => {
        const sheetsTabs = document.getElementById("sheets-tabs");
        const sheetsContainer = document.getElementById("sheets-container");
        const createSheetBtn = document.getElementById("create-sheet-btn");

        let sheets = await fetchData();
        if (sheets.length === 0) {
          const docRef = await addDoc(comparisonsRef, {
            name: "ÙˆØ±Ù‚Ø© 1",
            comparisons: [
              {
                companies: [
                  { name: "", product: "", price: "", weight: "" },
                  {
                    name: "",
                    product: "",
                    price: "",
                    weight: "",
                  },
                ],
              },
            ],
          });
          sheets = [
            {
              id: docRef.id,
              name: "ÙˆØ±Ù‚Ø© 1",
              comparisons: [
                {
                  companies: [
                    {
                      name: "",
                      product: "",
                      price: "",
                      weight: "",
                    },
                    {
                      name: "",
                      product: "",
                      price: "",
                      weight: "",
                    },
                  ],
                },
              ],
            },
          ];
        }

        let activeSheetId = sheets[0]?.id;
        let typingTimer;
        const doneTypingInterval = 3000;

        function calculateResults(companies) {
          const results = companies.map((c) => {
            const price = parseFloat(c.price);
            const weight = parseFloat(c.weight);
            return weight && price ? price / weight : null;
          });
          const validIndexes = results
            .map((v, i) => ({ value: v, index: i }))
            .filter((v) => v.value !== null);
          const minValue = Math.min(...validIndexes.map((v) => v.value));
          const bestCompanies = validIndexes
            .filter((v) => v.value === minValue)
            .map((v) => companies[v.index].name);
          const diffPercent = validIndexes
            .filter((v) => v.value !== minValue)
            .map((v) => ((v.value - minValue) / v.value) * 100);
          return {
            better:
              bestCompanies.length > 1
                ? bestCompanies.join(" + ")
                : bestCompanies[0] || "-",
            diff: diffPercent.length ? Math.max(...diffPercent) : 0,
          };
        }

        function renderTabs() {
          sheetsTabs.innerHTML = "";
          sheets.forEach((sheet) => {
            const wrapper = document.createElement("div");
            wrapper.className = "flex items-center gap-1";

            const input = document.createElement("input");
            input.className = `px-3 py-1 rounded-full text-sm border w-28 text-center transition ${
              sheet.id === activeSheetId
                ? "bg-blue-600 text-white border-blue-600"
                : "bg-white text-blue-600 border-blue-600"
            }`;
            input.value = sheet.name;
            input.oninput = () => {
              sheet.name = input.value;
              clearTimeout(typingTimer);
              typingTimer = setTimeout(() => saveSheet(sheet.id, sheet), 1000);
            };

            const tabBtn = document.createElement("button");
            tabBtn.textContent = "ğŸ”„";
            tabBtn.title = "Ø¹Ø±Ø¶ Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ±Ù‚Ø©";
            tabBtn.className =
              "text-sm px-1 py-1 text-gray-600 hover:text-blue-700";
            tabBtn.onclick = () => {
              activeSheetId = sheet.id;
              renderTabs();
              renderSheet();
            };

            wrapper.appendChild(tabBtn);
            wrapper.appendChild(input);
            sheetsTabs.appendChild(wrapper);
          });
        }

        function renderSheet() {
          const sheet = sheets.find((s) => s.id === activeSheetId);
          if (!sheet) return;

          sheetsContainer.innerHTML =
            sheet.comparisons
              .map((comp, compIndex) => {
                const { better, diff } = calculateResults(comp.companies);
                return `
              <div class="bg-white rounded-xl p-4 shadow mb-4 relative group">
                <button onclick="removeComparison(${compIndex})" class="absolute top-2 left-2 text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100 transition">ğŸ—‘ï¸</button>
                <div class="grid grid-cols-1 gap-4">
                  ${comp.companies
                    .map(
                      (c, i) => `
                    <div class="grid grid-cols-5 gap-4 items-center">
                      <input value="${c.name}" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©" class="p-2 border rounded text-right w-full" />
                      <input value="${c.product}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" class="p-2 border rounded text-right w-full" />
                      <input type="number" step="any" min="0" value="${c.price}" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ" class="p-2 border rounded text-right w-full" />
                      <input type="number" step="any" min="0" value="${c.weight}" placeholder="Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)" class="p-2 border rounded text-right w-full" />
                      <button onclick="removeCompany(${compIndex}, ${i})" class="text-red-500 hover:text-red-700">âŒ</button>
                    </div>
                  `
                    )
                    .join("")}
                </div>
                <div class="flex justify-between mt-4">
                  <button onclick="addCompany(${compIndex});" class="bg-green-600 text-white px-4 py-2 rounded shadow">â• Ø´Ø±ÙƒØ©</button>
                </div>
                <div class="text-center mt-4 text-lg font-semibold text-indigo-700">
                  Ø§Ù„Ø£ÙØ¶Ù„ Ø³Ø¹Ø±Ø§Ù‹: <span>${better}</span> | ÙØ±Ù‚ Ø§Ù„Ø³Ø¹Ø±: <span>${
                  isNaN(diff) ? "-" : diff.toFixed(1)
                }%</span>
                </div>
              </div>
            `;
              })
              .join("") +
            `
            <div class="flex justify-end gap-2">
              <button onclick="addComparison();" class="bg-blue-600 text-white px-4 py-2 rounded shadow">â• Ù…Ù‚Ø§Ø±Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
              <button onclick="exportToExcel();" class="bg-yellow-500 text-white px-4 py-2 rounded shadow">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button>
            </div>`;

          setTimeout(() => {
            const inputs = sheetsContainer.querySelectorAll("input");
            inputs.forEach((input) => {
              input.addEventListener("input", () => {
                clearTimeout(typingTimer);
                typingTimer = setTimeout(() => {
                  const sheet = sheets.find((s) => s.id === activeSheetId);
                  const comparisonBlocks = sheetsContainer.querySelectorAll(
                    ".bg-white.rounded-xl"
                  );
                  comparisonBlocks.forEach((block, compIndex) => {
                    const inputGroups =
                      block.querySelectorAll(".grid.grid-cols-5");
                    inputGroups.forEach((group, i) => {
                      const fields = group.querySelectorAll("input");
                      if (fields.length === 4) {
                        sheet.comparisons[compIndex].companies[i] = {
                          name: fields[0].value,
                          product: fields[1].value,
                          price: fields[2].value,
                          weight: fields[3].value,
                        };
                      }
                    });
                  });
                  saveSheet(sheet.id, sheet);
                  renderSheet();
                }, doneTypingInterval);
              });
            });
          }, 0);
        }

        window.addCompany = (compIndex) => {
          const sheet = sheets.find((s) => s.id === activeSheetId);
          sheet.comparisons[compIndex].companies.push({
            name: "",
            product: "",
            price: "",
            weight: "",
          });
          saveSheet(sheet.id, sheet);
          renderSheet();
        };

        window.removeCompany = (compIndex, companyIndex) => {
          const sheet = sheets.find((s) => s.id === activeSheetId);
          if (sheet.comparisons[compIndex].companies.length > 2) {
            sheet.comparisons[compIndex].companies.splice(companyIndex, 1);
            saveSheet(sheet.id, sheet);
            renderSheet();
          } else {
            alert("ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø¹Ù„Ù‰ Ø´Ø±ÙƒØªÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
          }
        };

        window.removeComparison = (compIndex) => {
          const sheet = sheets.find((s) => s.id === activeSheetId);
          sheet.comparisons.splice(compIndex, 1);
          saveSheet(sheet.id, sheet);
          renderSheet();
        };

        window.addComparison = () => {
          const sheet = sheets.find((s) => s.id === activeSheetId);
          sheet.comparisons.push({
            companies: [
              { name: "", product: "", price: "", weight: "" },
              { name: "", product: "", price: "", weight: "" },
            ],
          });
          saveSheet(sheet.id, sheet);
          renderSheet();
        };

        window.exportToExcel = () => {
          const sheet = sheets.find((s) => s.id === activeSheetId);
          const rows = [
            [
              "Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©",
              "Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬",
              "Ø§Ù„Ø³Ø¹Ø±",
              "Ø§Ù„ÙˆØ²Ù†",
              "Ø³Ø¹Ø± Ø§Ù„ÙƒÙŠÙ„Ùˆ",
              "Ø§Ù„Ø£ÙØ¶Ù„ Ø³Ø¹Ø±Ø§Ù‹",
              "ÙØ±Ù‚ Ø§Ù„Ø³Ø¹Ø±",
            ],
          ];
          sheet.comparisons.forEach((comp) => {
            const { better, diff } = calculateResults(comp.companies);
            comp.companies.forEach((c) => {
              const kilo =
                c.weight && c.price
                  ? (parseFloat(c.price) / parseFloat(c.weight)).toFixed(2)
                  : "-";
              rows.push([
                c.name,
                c.product,
                c.price,
                c.weight,
                kilo,
                better,
                isNaN(diff) ? "-" : diff.toFixed(1) + "%",
              ]);
            });
            rows.push([]);
          });
          const ws = XLSX.utils.aoa_to_sheet(rows);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, sheet.name);
          XLSX.writeFile(wb, `${sheet.name}.xlsx`);
        };

        createSheetBtn.onclick = async () => {
          const name = `ÙˆØ±Ù‚Ø© ${sheets.length + 1}`;
          const docRef = await addDoc(comparisonsRef, {
            name,
            comparisons: [
              {
                companies: [
                  { name: "", product: "", price: "", weight: "" },
                  {
                    name: "",
                    product: "",
                    price: "",
                    weight: "",
                  },
                ],
              },
            ],
          });
          sheets.push({
            id: docRef.id,
            name,
            comparisons: [
              {
                companies: [
                  { name: "", product: "", price: "", weight: "" },
                  {
                    name: "",
                    product: "",
                    price: "",
                    weight: "",
                  },
                ],
              },
            ],
          });
          activeSheetId = docRef.id;
          renderTabs();
          renderSheet();
        };

        renderTabs();
        renderSheet();
      });
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Cairo", sans-serif;
        background-color: #f9fafb;
      }
    </style>
  </head>
  <body>
    <div class="container mx-auto max-w-6xl mb-2">
      <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">
        Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ù†ØªØ¬Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©
      </h1>
      <div class="flex justify-center mb-4">
        <button
          id="create-sheet-btn"
          class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow"
        >
          â• ÙˆØ±Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©
        </button>
      </div>
      <div
        id="sheets-tabs"
        class="flex flex-wrap gap-2 justify-center mb-4"
      ></div>
      <div id="sheets-container"></div>
    </div>
  </body>
</html>
