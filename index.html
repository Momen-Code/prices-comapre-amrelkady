<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª - ØªØµÙ…ÙŠÙ… Ø¨Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        addDoc,
        setDoc,
        doc,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBnH-VzVeKw4-ebADGCyS_QIVWcolQqwF4",
        authDomain: "amrelkady-7455d.firebaseapp.com",
        projectId: "amrelkady-7455d",
        storageBucket: "amrelkady-7455d.firebasestorage.app",
        messagingSenderId: "1068284076708",
        appId: "1:1068284076708:web:02d47cc40d81cb6e21bc31",
        measurementId: "G-4YGNNJN2JH",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const comparisonsRef = collection(db, "comparisons");

      function getRandomColor() {
        const colors = [
          "text-red-600",
          "text-blue-600",
          "text-green-600",
          "text-purple-600",
          "text-yellow-600",
          "text-pink-600",
          "text-orange-600",
        ];
        return colors[Math.floor(Math.random() * colors.length)];
      }

      async function fetchData() {
        const snapshot = await getDocs(comparisonsRef);
        return snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
      }

      async function saveSheet(id, data) {
        await setDoc(doc(db, "comparisons", id), data);
      }

      function calculateResults(companies) {
        const results = companies.map((c) => {
          const price = parseFloat(c.price);
          const weight = parseFloat(c.weight);
          return weight && price ? price / weight : null;
        });
        const valid = results
          .map((val, idx) => ({ val, idx }))
          .filter((r) => r.val !== null);
        const minVal = Math.min(...valid.map((v) => v.val));
        const bestCompanies = valid
          .filter((v) => v.val === minVal)
          .map((v) => companies[v.idx].name || `Ø´Ø±ÙƒØ© ${v.idx + 1}`);
        const diffs = valid.map((v) => {
          if (v.val === minVal) return "0";
          return (((v.val - minVal) / v.val) * 100).toFixed(1);
        });
        return {
          better: bestCompanies.join(" + ") || "-",
          diffs: results.map((val, idx) =>
            val !== null
              ? val === minVal
                ? "0"
                : diffs[valid.findIndex((v) => v.idx === idx)]
              : "-"
          ),
        };
      }

      window.addEventListener("DOMContentLoaded", async () => {
        const sheetsTabs = document.getElementById("sheets-tabs");
        const sheetsContainer = document.getElementById("sheets-container");
        const createSheetBtn = document.getElementById("create-sheet-btn");

        let sheets = await fetchData();
        if (sheets.length === 0) {
          const docRef = await addDoc(comparisonsRef, {
            name: "ÙˆØ±Ù‚Ø© 1",
            comparisons: [
              {
                companies: [
                  { name: "", product: "", price: "", weight: "" },
                  { name: "", product: "", price: "", weight: "" },
                ],
              },
            ],
          });
          sheets = [
            {
              id: docRef.id,
              name: "ÙˆØ±Ù‚Ø© 1",
              comparisons: [
                {
                  companies: [
                    { name: "", product: "", price: "", weight: "" },
                    { name: "", product: "", price: "", weight: "" },
                  ],
                },
              ],
            },
          ];
        }

        let activeSheetId = sheets[0]?.id;

        function renderTabs() {
          sheetsTabs.innerHTML = "";
          sheets.forEach((sheet) => {
            const wrapper = document.createElement("div");
            wrapper.className = "flex items-center gap-1";

            const input = document.createElement("input");
            input.className = `px-3 py-1 rounded-full text-sm border w-28 text-center transition ${
              sheet.id === activeSheetId
                ? "bg-blue-600 text-white border-blue-600"
                : "bg-white text-blue-600 border-blue-600"
            }`;
            input.value = sheet.name;
            input.oninput = () => {
              sheet.name = input.value;
              setTimeout(() => saveSheet(sheet.id, sheet), 1000);
            };

            const tabBtn = document.createElement("button");
            tabBtn.textContent = "ğŸ”„";
            tabBtn.title = "Ø¹Ø±Ø¶ Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ±Ù‚Ø©";
            tabBtn.className =
              "text-sm px-1 py-1 text-gray-600 hover:text-blue-700";
            tabBtn.onclick = () => {
              activeSheetId = sheet.id;
              renderTabs();
              renderSheet();
              attachInputListeners();
            };

            wrapper.appendChild(tabBtn);
            wrapper.appendChild(input);
            sheetsTabs.appendChild(wrapper);
          });
        }

        function attachInputListeners() {
          const sheet = sheets.find((s) => s.id === activeSheetId);
          if (!sheet) return;

          document
            .querySelectorAll("#sheets-container input")
            .forEach((input) => {
              let timeout;
              input.addEventListener("input", (e) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                  const allInputs = Array.from(
                    document.querySelectorAll("#sheets-container input")
                  );
                  const index = allInputs.indexOf(input);
                  let compIdx = 0,
                    fieldIdx = index;
                  for (const comp of sheet.comparisons) {
                    const count = comp.companies.length * 4;
                    if (fieldIdx < count) break;
                    fieldIdx -= count;
                    compIdx++;
                  }
                  const companyIdx = Math.floor(fieldIdx / 4);
                  const fieldType = ["name", "product", "price", "weight"][
                    fieldIdx % 4
                  ];
                  sheet.comparisons[compIdx].companies[companyIdx][fieldType] =
                    e.target.value;

                  saveSheet(sheet.id, sheet);
                  renderSheet();
                  attachInputListeners();
                }, 1000);
              });
            });
        }

        function renderSheet() {
          const sheet = sheets.find((s) => s.id === activeSheetId);
          if (!sheet) return;

          sheetsContainer.innerHTML =
            sheet.comparisons
              .map((comp, compIndex) => {
                const { better, diffs } = calculateResults(comp.companies);
                return `
            <div class="bg-white rounded-xl shadow p-4 mb-4 relative group">
              <button onclick="removeComparison(${compIndex})" class="absolute top-2 left-2 text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100 transition">ğŸ—‘ï¸</button>
              <h3 class="text-lg font-bold text-right text-indigo-700 mb-2">
                Ù…Ù‚Ø§Ø±Ù†Ø© ${compIndex + 1}
                </h3>
              <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
                ${comp.companies
                  .map((c, i) => {
                    const color = getRandomColor();
                    return `
                  <div class="bg-gray-50 p-4 rounded shadow space-y-2">
                    <input value="${c.name}" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©" class="w-full border p-2 rounded text-right ${color} text-lg font-bold" />
                    <input value="${c.product}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" class="w-full border p-2 rounded text-right" />
                    <input type="number" min="0" step="any" value="${c.price}" placeholder="Ø§Ù„Ø³Ø¹Ø±" class="w-full border p-2 rounded text-right" />
                    <input type="number" min="0" step="any" value="${c.weight}" placeholder="Ø§Ù„ÙˆØ²Ù†" class="w-full border p-2 rounded text-right" />
                    <button onclick="removeCompany(${compIndex}, ${i})" class="text-red-500 hover:text-red-700">âŒ Ø­Ø°Ù Ø§Ù„Ø´Ø±ÙƒØ©</button>
                  </div>`;
                  })
                  .join("")}
              </div>
              <div class="flex justify-between mt-4">
                <button onclick="addCompany(${compIndex})" class="bg-green-600 text-white px-4 py-2 rounded shadow">â• Ø´Ø±ÙƒØ©</button>
              </div>
              <div class="mt-4 text-center text-lg font-semibold text-indigo-700">
                Ø§Ù„Ø£ÙØ¶Ù„ Ø³Ø¹Ø±Ø§Ù‹: <span>${better}</span>
              </div>
              <div class="mt-2 text-center text-md text-gray-600">
                ÙØ±Ù‚ Ø§Ù„Ø³Ø¹Ø±: ${diffs
                  .map((diff, idx) => {
                    if (diff === "0") return;
                    return `<span class="${getRandomColor()}">${diff}%</span>`;
                  })
                  .join(" ")}
              </div>
            </div>`;
              })
              .join("") +
            `<div class="flex justify-end gap-2">
              <button onclick="addComparison();" class="bg-blue-600 text-white px-4 py-2 rounded shadow">â• Ù…Ù‚Ø§Ø±Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
              <button onclick="exportToExcel();" class="bg-yellow-500 text-white px-4 py-2 rounded shadow">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button>
            </div>`;
        }

        renderTabs();
        renderSheet();
        attachInputListeners();

        window.addCompany = function (compIndex) {
          const sheet = sheets.find((s) => s.id === activeSheetId);
          if (!sheet) return;
          sheet.comparisons[compIndex].companies.push({
            name: "",
            product: "",
            price: "",
            weight: "",
          });
          saveSheet(sheet.id, sheet);
          renderSheet();
          attachInputListeners();
        };

        window.removeCompany = function (compIndex, companyIdx) {
          const sheet = sheets.find((s) => s.id === activeSheetId);
          if (!sheet || sheet.comparisons[compIndex].companies.length <= 2)
            return;
          sheet.comparisons[compIndex].companies.splice(companyIdx, 1);
          saveSheet(sheet.id, sheet);
          renderSheet();
          attachInputListeners();
        };

        window.addComparison = function () {
          const sheet = sheets.find((s) => s.id === activeSheetId);
          if (!sheet) return;
          sheet.comparisons.push({
            companies: [
              { name: "", product: "", price: "", weight: "" },
              { name: "", product: "", price: "", weight: "" },
            ],
          });
          saveSheet(sheet.id, sheet);
          renderSheet();
          attachInputListeners();
        };

        window.removeComparison = function (compIndex) {
          const sheet = sheets.find((s) => s.id === activeSheetId);
          if (!sheet) return;
          sheet.comparisons.splice(compIndex, 1);
          saveSheet(sheet.id, sheet);
          renderSheet();
          attachInputListeners();
        };

        window.addSheet = async function () {
          const docRef = await addDoc(comparisonsRef, {
            name: `ÙˆØ±Ù‚Ø© ${sheets.length + 1}`,
            comparisons: [
              {
                companies: [
                  { name: "", product: "", price: "", weight: "" },
                  { name: "", product: "", price: "", weight: "" },
                ],
              },
            ],
          });
          const newSheet = {
            id: docRef.id,
            name: `ÙˆØ±Ù‚Ø© ${sheets.length + 1}`,
            comparisons: [
              {
                companies: [
                  { name: "", product: "", price: "", weight: "" },
                  { name: "", product: "", price: "", weight: "" },
                ],
              },
            ],
          };
          sheets.push(newSheet);
          activeSheetId = newSheet.id;
          renderTabs();
          renderSheet();
          attachInputListeners();
        };

        window.exportToExcel = function () {
          const sheet = sheets.find((s) => s.id === activeSheetId);
          if (!sheet) return;

          const rows = [
            [
              "Ø§Ù„Ø´Ø±ÙƒØ©",
              "Ø§Ù„Ù…Ù†ØªØ¬",
              "Ø§Ù„Ø³Ø¹Ø±",
              "Ø§Ù„ÙˆØ²Ù†",
              "Ø³Ø¹Ø± Ø§Ù„ÙƒÙŠÙ„Ùˆ",
              "Ø§Ù„Ø£ÙØ¶Ù„ Ø³Ø¹Ø±Ø§Ù‹",
              "ÙØ±Ù‚ Ø§Ù„Ø³Ø¹Ø± (%)",
            ],
          ];

          sheet.comparisons.forEach((comp) => {
            const result = calculateResults(comp.companies);
            comp.companies.forEach((company, idx) => {
              const price = parseFloat(company.price);
              const weight = parseFloat(company.weight);
              const kilo = price && weight ? (price / weight).toFixed(2) : "-";
              rows.push([
                company.name || "",
                company.product || "",
                company.price || "",
                company.weight || "",
                kilo,
                result.better,
                result.diffs[idx] || "-",
              ]);
            });
            rows.push([]);
          });

          const worksheet = XLSX.utils.aoa_to_sheet(rows);
          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, sheet.name);
          XLSX.writeFile(workbook, `${sheet.name}.xlsx`);
        };
      });
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Cairo", sans-serif;
        background-color: #f9fafb;
      }
    </style>
  </head>
  <body>
    <div class="container mx-auto max-w-6xl mb-2">
      <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">
        Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ù†ØªØ¬Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©
      </h1>
      <div class="flex justify-center mb-4">
        <button
          id="create-sheet-btn"
          class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow"
          onclick="addSheet()"
        >
          â• ÙˆØ±Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©
        </button>
      </div>
      <div
        id="sheets-tabs"
        class="flex flex-wrap gap-2 justify-center mb-4"
      ></div>
      <div id="sheets-container"></div>
    </div>
  </body>
</html>
